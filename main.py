# Dataset 
data = [
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 9.0, "Skor_Ujian": 85, "Hasil": "Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 7.5, "Skor_Ujian": 65, "Hasil": "Tidak Diterima"},
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 5.5, "Skor_Ujian": 20, "Hasil": "Tidak Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 8.5, "Skor_Ujian": 70, "Hasil": "Diterima"},
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 7.0, "Skor_Ujian": 45, "Hasil": "Tidak Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 5.0, "Skor_Ujian": 15, "Hasil": "Tidak Diterima"},
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 9.0, "Skor_Ujian": 90, "Hasil": "Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 7.5, "Skor_Ujian": 60, "Hasil": "Diterima"},
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 5.5, "Skor_Ujian": 18, "Hasil": "Tidak Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 8.5, "Skor_Ujian": 70, "Hasil": "Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 8.5, "Skor_Ujian": 70, "Hasil": "Diterima"},
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 7.0, "Skor_Ujian": 40, "Hasil": "Tidak Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 5.0, "Skor_Ujian": 10, "Hasil": "Tidak Diterima"},
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 9.0, "Skor_Ujian": 95, "Hasil": "Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 7.5, "Skor_Ujian": 60, "Hasil": "Diterima"},
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 5.5, "Skor_Ujian": 20, "Hasil": "Tidak Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 8.5, "Skor_Ujian": 75, "Hasil": "Diterima"},
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 7.0, "Skor_Ujian": 45, "Hasil": "Tidak Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 5.0, "Skor_Ujian": 12, "Hasil": "Tidak Diterima"},
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 9.0, "Skor_Ujian": 85, "Hasil": "Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 7.5, "Skor_Ujian": 65, "Hasil": "Diterima"},
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 5.5, "Skor_Ujian": 15, "Hasil": "Tidak Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 8.5, "Skor_Ujian": 70, "Hasil": "Diterima"},
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 7.0, "Skor_Ujian": 40, "Hasil": "Tidak Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 5.0, "Skor_Ujian": 18, "Hasil": "Tidak Diterima"},
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 9.0, "Skor_Ujian": 95, "Hasil": "Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 7.5, "Skor_Ujian": 60, "Hasil": "Diterima"},
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 5.5, "Skor_Ujian": 15, "Hasil": "Tidak Diterima"},
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 8.0, "Skor_Ujian": 78, "Hasil": "Diterima"}, 
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 6.8, "Skor_Ujian": 55, "Hasil": "Tidak Diterima"}, 
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 6.0, "Skor_Ujian": 30, "Hasil": "Tidak Diterima"}, 
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 7.8, "Skor_Ujian": 68, "Hasil": "Diterima"}, 
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 7.2, "Skor_Ujian": 50, "Hasil": "Diterima"}, 
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 4.5, "Skor_Ujian": 5, "Hasil": "Tidak Diterima"}, 
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 8.8, "Skor_Ujian": 80, "Hasil": "Diterima"}, 
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 7.0, "Skor_Ujian": 62, "Hasil": "Diterima"}, 
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 5.8, "Skor_Ujian": 25, "Hasil": "Tidak Diterima"}, 
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 8.0, "Skor_Ujian": 72, "Hasil": "Diterima"}, 
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 6.5, "Skor_Ujian": 48, "Hasil": "Tidak Diterima"}, 
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 5.2, "Skor_Ujian": 17, "Hasil": "Tidak Diterima"}, 
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 9.2, "Skor_Ujian": 92, "Hasil": "Diterima"}, 
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 7.3, "Skor_Ujian": 58, "Hasil": "Tidak Diterima"}, 
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 5.0, "Skor_Ujian": 22, "Hasil": "Tidak Diterima"}, 
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 8.2, "Skor_Ujian": 67, "Hasil": "Diterima"}, 
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 7.1, "Skor_Ujian": 42, "Hasil": "Tidak Diterima"}, 
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 4.8, "Skor_Ujian": 10, "Hasil": "Tidak Diterima"}, 
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 8.7, "Skor_Ujian": 88, "Hasil": "Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 7.6, "Skor_Ujian": 63, "Hasil": "Diterima"},
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 5.3, "Skor_Ujian": 16, "Hasil": "Tidak Diterima"}, 
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 8.3, "Skor_Ujian": 69, "Hasil": "Diterima"}, 
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 6.9, "Skor_Ujian": 43, "Hasil": "Tidak Diterima"}, 
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 5.1, "Skor_Ujian": 19, "Hasil": "Tidak Diterima"}, 
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 9.1, "Skor_Ujian": 91, "Hasil": "Diterima"}, 
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 7.4, "Skor_Ujian": 59, "Hasil": "Tidak Diterima"}, 
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 5.6, "Skor_Ujian": 21, "Hasil": "Tidak Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "IPA", "Prioritas": 1, "Rata_rata_NA": 8.6, "Skor_Ujian": 74, "Hasil": "Diterima"}, 
    {"Jurusan_SMA": "IPA", "Jurusan_Pilihan": "IPS", "Prioritas": 2, "Rata_rata_NA": 6.7, "Skor_Ujian": 41, "Hasil": "Tidak Diterima"},
    {"Jurusan_SMA": "IPS", "Jurusan_Pilihan": "Kejuruan", "Prioritas": 3, "Rata_rata_NA": 4.9, "Skor_Ujian": 11, "Hasil": "Tidak Diterima"}, 
]

# Fungsi untuk menghitung logaritma natural (ln) dari angka x, yang mengimplementasikan deret Taylor untuk ln((1+y)/(1-y))
def ln(x):
    if x <= 0:
        return 0
    n = 100
    result = 0
    y = (x - 1) / (x + 1)
    for i in range(1, 2 * n, 2):
        result += (1 / i) * (y ** i)
    return 2 * result

# Fungsi untuk menghitung logaritma basis 2 dari x, yang memanfaatkan hubungan log2(x) = ln(x) / ln(2).
def log2(x):
    return ln(x) / ln(2)

# Fungsi untuk menghitung entropi (ketidakmurnian) dari dataset
def entropy(rows):
    total = len(rows)
    if total == 0:
        return 0
    counts = {}
    for row in rows:
        label = row["Hasil"]
        counts[label] = counts.get(label, 0) + 1
    result = 0
    for label in counts:
        p = counts[label] / total
        result -= p * log2(p)
    return result

# Fungsi untuk memeriksa apakah nilai adalah numerik (int atau float)
def is_numeric(value):
    return isinstance(value, int) or isinstance(value, float)

# Fungsi untuk membagi dataset berdasarkan fitur dan nilai tertentu
def split(rows, feature, value):
    if is_numeric(value):
        left = [row for row in rows if row[feature] <= value]
        right = [row for row in rows if row[feature] > value]
    else:
        left = [row for row in rows if row[feature] == value]
        right = [row for row in rows if row[feature] != value]
    return left, right

# Fungsi untuk mencari pembagian terbaik berdasarkan fitur dan nilai
def best_split(rows, features):
    best_gain = 0
    best_feature = None
    best_value = None
    base_entropy = entropy(rows)

    for feature in features:
        values = set(row[feature] for row in rows)
        for val in values:
            left, right = split(rows, feature, val)
            if not left or not right:
                continue
            p = len(left) / len(rows)
            gain = base_entropy - (p * entropy(left) + (1 - p) * entropy(right))
            if gain > best_gain:
                best_gain = gain
                best_feature = feature
                best_value = val
    return best_feature, best_value

# Fungsi rekursif untuk membangun pohon keputusan
def build_tree(rows, features):
    labels = [row["Hasil"] for row in rows]
    if labels.count(labels[0]) == len(labels):
        return labels[0]
    if not features:
        return max(set(labels), key=labels.count)

    best_feat, best_val = best_split(rows, features)
    if best_feat is None:
        return max(set(labels), key=labels.count)

    left, right = split(rows, best_feat, best_val)
    return {
        "feature": best_feat,
        "value": best_val,
        "left": build_tree(left, features),
        "right": build_tree(right, features)
    }

# Fungsi untuk mencetak pohon keputusan
def print_tree(tree, indent=""):
    if isinstance(tree, dict):
        operator = "<=" if is_numeric(tree["value"]) else "=="
        print(f"{indent}{tree['feature']} {operator} {tree['value']}")
        print(f"{indent}   True:")
        print_tree(tree['left'], indent + "     ")
        print(f"{indent}   False:")
        print_tree(tree['right'], indent + "     ")
    else:
        print(f"{indent}[Label: {tree}]")

# Fungsi untuk memprediksi hasil berdasarkan pohon keputusan
def predict(tree, sample):
    if isinstance(tree, dict):
        val = sample[tree["feature"]]
        if is_numeric(tree["value"]):
            branch = tree["left"] if val <= tree["value"] else tree["right"]
        else:
            branch = tree["left"] if val == tree["value"] else tree["right"]
        return predict(branch, sample)
    else:
        return tree

## Bagian Model Evaluasi (F1-Score)

# Fungsi untuk membagi data menjadi training dan testing set secara manual
# Tanpa pengacakan sesuai batasan, ini akan mengambil proporsi awal dari data.
def train_test_split_manual(data_list, test_size=0.2):
    temp_data = list(data_list) 
    split_index = int(len(temp_data) * (1 - test_size))
    train_data = temp_data[:split_index]
    test_data = temp_data[split_index:]
    return train_data, test_data

# Fungsi untuk menghitung F1-Score
def calculate_f1_score(tree, test_data):
    true_positives = 0
    false_positives = 0
    false_negatives = 0

    # Asumsi: "Diterima" adalah kelas positif
    positive_class = "Diterima"

    for row in test_data:
        actual = row["Hasil"]
        predicted = predict(tree, row)

        if actual == positive_class and predicted == positive_class:
            true_positives += 1
        elif actual != positive_class and predicted == positive_class: # predicted positive, but actually negative
            false_positives += 1
        elif actual == positive_class and predicted != positive_class: # actually positive, but predicted negative
            false_negatives += 1
    
    # Menghitung Presisi
    precision = true_positives / (true_positives + false_positives) if (true_positives + false_positives) > 0 else 0
    
    # Menghitung Recall
    recall = true_positives / (true_positives + false_negatives) if (true_positives + false_negatives) > 0 else 0
    
    # Menghitung F1-Score
    f1_score = 2 * (precision * recall) / (precision + recall) if (precision + recall) > 0 else 0
    
    return f1_score

# --- Main Program ---
features = ["Jurusan_SMA", "Jurusan_Pilihan", "Prioritas", "Rata_rata_NA", "Skor_Ujian"]

# 1. Bagi data menjadi training dan testing
train_data, test_data = train_test_split_manual(data, test_size=0.2) # 80% training, 20% testing

# 2. Bangun pohon menggunakan DATA PELATIHAN
tree = build_tree(train_data, features)
print("\n============ Pohon Keputusan ============\n")
print_tree(tree)

print("\n----- Masukkan data untuk prediksi: -----")
try:
    sample = {}
    sample["Jurusan_SMA"] = input("\nJurusan SMA (IPA/IPS)            : ")
    sample["Jurusan_Pilihan"] = input("Jurusan Pilihan (IPA/IPS/Kejuruan) : ")
    sample["Prioritas"] = int(input("Pilihan Keberapa (1/2/3)           : "))
    sample["Rata_rata_NA"] = float(input("Rata-rata Nilai Akhir              : "))
    sample["Skor_Ujian"] = float(input("Skor Ujian UTBK                    : "))

    hasil = predict(tree, sample)
    print(f"\nHasil Prediksi                     : {hasil}")

    f1_hasil_evaluasi = calculate_f1_score(tree, test_data)
    print(f"\n--- F1-Score Model pada Data Pengujian: {f1_hasil_evaluasi:.4f} ---")

except Exception as e:
    print("Input tidak valid:", e)